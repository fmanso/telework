name: Release (zip)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: electron/package-lock.json

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Publish .NET (self-contained)
        run: dotnet publish "TeleworkApp/TeleworkApp.csproj" -c Release -r win-x64 --self-contained true -o "electron/dotnet"

      - name: Install Electron dependencies
        working-directory: electron
        run: npm ci

      - name: Build installer
        working-directory: electron
        run: npm run build

      - name: Create release zip
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $tag = "${{ github.ref_name }}"
          $zipName = "TeleworkTracker-$tag-windows-x64.zip"
          $zipPath = Join-Path $env:GITHUB_WORKSPACE $zipName

          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }

          # electron-builder outputs to electron/dist (see electron/package.json build.directories.output)
          $distDir = Join-Path $env:GITHUB_WORKSPACE "electron/dist"
          if (-not (Test-Path $distDir)) {
            throw "Expected dist folder not found: $distDir"
          }

          # Include the produced installer and any metadata files (e.g. latest.yml)
          Compress-Archive -Path (Join-Path $distDir '*') -DestinationPath $zipPath

          "ZIP_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_PATH }}
          generate_release_notes: true
